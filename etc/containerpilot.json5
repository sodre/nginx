{
  consul: "{{ if .CONSUL_AGENT }}localhost{{ else }}{{ if .CONSUL }}{{ .CONSUL }}{{ else }}consul{{ end }}{{ end }}:8500",
  jobs: [
    //
    // NGINX itself
    {
      name: "preStart",
      exec: "generate-config",
      when: {
        source: "consul-agent",
        once: "healthy"
      },
    },
    {
      name: "nginx",
      port: 80,
      interfaces: ["eth0"],
      exec: "nginx",
      when: {
        source: "preStart",
        once: "exitSuccess"
      },
      health: {
        exec: "health-check http",
        interval: 10,
        ttl: 25
      }
    },
    {
      name: "nginx-public",
      port: 80,
      interfaces: ["eth1", "eth0"],
      when: {
        source: "nginx",
        once: "healthy"
      },
      health: {
        exec: "health-check http",
        interval: 10,
        ttl: 25,
      }
    },

    //
    // The ACME work
    {{ if .ACME_DOMAIN }}{
      name: "acme-init",
      when: {
        source: "nginx",
        once: "healthy"
      },
      exec: "acme init",
      restarts: "unlimited"
    },
    {
      name: "acme-watch",
      exec: ["acme", "watch"],
      when: {
        source: "acme-init",
        once: "exitSuccess"
      },
      restarts: "unlimited"
    },
    {
      name: "acme-checkin",
      exec: [ "acme", "checkin" ],
      timeout: "10s",
      when: {
        interval: "1h",
      }
    },
    {
      name: "nginx-ssl",
      port: 443,
      interfaces: ["eth0"],
      when: {
        source: "acme-init",
        once: "exitSuccess"
      },
      health: {
        exec: "health-check https",
        interval: 10,
        ttl: 25
      }
    },
    {
      name: "nginx-public-ssl",
      port: 443,
      interfaces: ["eth0", "eth1"],
      when: {
        source: "nginx-ssl",
        once: "healthy"
      },
      health: {
        exec: "health-check https",
        interval: 10,
        ttl: 25,
      }
    },{{ end }}

    //
    // The Consul Agent
    {{ if .CONSUL_AGENT }}{
      name: "consul-prestart",
      exec: [
        "consul-manage", "preStart"
      ]
    },
    {
      name: "consul-agent",
      exec: [
        "consul", "agent",
        "-data-dir=/var/lib/consul",
        "-config-dir=/etc/consul",
        "-rejoin",
        "-retry-join", "{{ if .CONSUL }}{{ .CONSUL }}{{ else }}consul{{ end }}",
        "-retry-max", "10",
        "-retry-interval", "10s"
      ],
      health: {
        exec: "curl -so /dev/null http://localhost:8500",
        interval: 10,
        ttl: 25
      },
      restarts: "unlimited"
    },{{ end }}
    {
      // this sensor runs -putmetric to each of the metrics described
      // in the telemetry/metrics block below
      name: "sensor",
      exec: "/usr/local/bin/sensor",
      when: {
        interval: "5s"
      }
    },
    {{ if .BACKEND }}
    //
    // The BACKEND watcher, if we have one
    {
      name: "onChange",
      exec: "reload",
      when: {
        source: "watch.{{ .BACKEND }}",
        each: "changed"
      }
    }
  ],
  watches: [
    {
      name: "{{ .BACKEND }}",
      interval: 7
    }
  {{ end }}
  ],
  telemetry: {
    port: 9090,
    metrics: [
      {
        name: "nginx_connections_unhandled_total",
        help: "Number of accepted connnections that were not handled",
        type: "gauge"
      },
      {
        name: "nginx_connections_load",
        help: "Ratio of active connections (less waiting) to the maximum worker connections",
        type: "gauge"
      }
    ]
  }
}
